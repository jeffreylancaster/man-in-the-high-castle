<!DOCTYPE html>
<html>
  <head>
    <title>Man in the High Castle: Time Per Character</title>
    <meta charset="UTF-8">
    <meta name="description" content="Man in the High Castle: Time Per Character">
    <meta name="author" content="Jeffrey Lancaster">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
  </head>
  <body>
    <p>
      <select id="order">
        <option value="name">Order by Name</option>
        <option value="count">Order by Frequency</option>
        <!-- <option value="group">Order by Cluster</option> -->
      </select>
    </p>
    <svg class="matrix"></svg>

    <script src="https://d3js.org/d3.v2.min.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
/* HELPFUL FUNCTIONS */

// to convert scene start/end times into seconds
function sec(timeString){
  var sec = 0;
  if (timeString.length == 0) return sec;
  var splitArray = timeString.split(":");
  sec = 3600*parseFloat(splitArray[0])+60*parseFloat(splitArray[1])+parseFloat(splitArray[2]);
  return sec;
}

// to convert milliseconds into hh:mm:ss
function millisecondsToHMS(d) {
  var date = new Date(null);
  date.setMilliseconds(d); // specify value for MILLISECONDS here
  return date.toISOString().substr(11, 8);
}

// to convert seconds into hh:mm:ss
function secondsToHMS(d) {
  var date = new Date(null);
  date.setSeconds(d); // specify value for SECONDS here
  return date.toISOString().substr(11, 8);
}

// to dedpulicate an array
function onlyUnique(value, index, self) { 
  return self.indexOf(value) === index;
}


var config = {
  "title": "Character Co-Occurrence",
  "width":3000,
  "height":3000,
  "margin":{
    "top": 200,
    "right": 40,
    "bottom": 30,
    "left": 200
  }
}

/* IMPORT DATA */
d3.queue()
  .defer(d3.json, '../data/synonyms.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e10-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e10-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e10-xray.json')
  .await(ready);

function ready(error, synonyms, s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10) {
  if (error) throw error;
  console.log("now that the files are loaded... do magic.");

  s1e1 = {...s1e1, 'seasonNum': 1, 'episodeNum': 1};
  s1e2 = {...s1e2, 'seasonNum': 1, 'episodeNum': 2};
  s1e3 = {...s1e3, 'seasonNum': 1, 'episodeNum': 3};
  s1e4 = {...s1e4, 'seasonNum': 1, 'episodeNum': 4};
  s1e5 = {...s1e5, 'seasonNum': 1, 'episodeNum': 5};
  s1e6 = {...s1e6, 'seasonNum': 1, 'episodeNum': 6};
  s1e7 = {...s1e7, 'seasonNum': 1, 'episodeNum': 7};
  s1e8 = {...s1e8, 'seasonNum': 1, 'episodeNum': 8};
  s1e9 = {...s1e9, 'seasonNum': 1, 'episodeNum': 9};
  s1e10 = {...s1e10, 'seasonNum': 1, 'episodeNum': 10};
  s2e1 = {...s2e1, 'seasonNum': 2, 'episodeNum': 1};
  s2e2 = {...s2e2, 'seasonNum': 2, 'episodeNum': 2};
  s2e3 = {...s2e3, 'seasonNum': 2, 'episodeNum': 3};
  s2e4 = {...s2e4, 'seasonNum': 2, 'episodeNum': 4};
  s2e5 = {...s2e5, 'seasonNum': 2, 'episodeNum': 5};
  s2e6 = {...s2e6, 'seasonNum': 2, 'episodeNum': 6};
  s2e7 = {...s2e7, 'seasonNum': 2, 'episodeNum': 7};
  s2e8 = {...s2e8, 'seasonNum': 2, 'episodeNum': 8};
  s2e9 = {...s2e9, 'seasonNum': 2, 'episodeNum': 9};
  s2e10 = {...s2e10, 'seasonNum': 2, 'episodeNum': 10};
  s3e1 = {...s3e1, 'seasonNum': 3, 'episodeNum': 1};
  s3e2 = {...s3e2, 'seasonNum': 3, 'episodeNum': 2};
  s3e3 = {...s3e3, 'seasonNum': 3, 'episodeNum': 3};
  s3e4 = {...s3e4, 'seasonNum': 3, 'episodeNum': 4};
  s3e5 = {...s3e5, 'seasonNum': 3, 'episodeNum': 5};
  s3e6 = {...s3e6, 'seasonNum': 3, 'episodeNum': 6};
  s3e7 = {...s3e7, 'seasonNum': 3, 'episodeNum': 7};
  s3e8 = {...s3e8, 'seasonNum': 3, 'episodeNum': 8};
  s3e9 = {...s3e9, 'seasonNum': 3, 'episodeNum': 9};
  s3e10 = {...s3e10, 'seasonNum': 3, 'episodeNum': 10};

  // massage the data
  var episodes = [s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10];
  
  for(var i in synonyms){
    for(j=0; j<synonyms[i].aliases.length; j++){
      synonyms[synonyms[i].aliases[j]] = {};
      synonyms[synonyms[i].aliases[j]].accepted = synonyms[i].accepted; 
    }
  }

  episodes.forEach(function(item, i){
    // add all x-ray items from episode
    var items = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].items; // a list of all characters, soundtrack, trivia, etc.
    item.items = items;
    
    // 1 if season 1, 2; 2 if season 3
    // season 1, 2
      // widgetList[0] is showing cast (tabType: "castTab")
      // widgetList[1] is showing scenes and time ranges (tabType: "scenesTab")
      // widgetList[2] is showing characters (tabType: "characterTab")
      // widgetList[3] is showing music list (tabType: "musicTab")
      // widgetList[4] is showing trivia (tabType: "triviaTab")
    // season 3
      // widgetList[0] is showing photos and videos gallery (tabType: "galleryTab")
      // widgetList[1] is showing cast (tabType: "castTab")
      // widgetList[2] is showing scenes and time ranges (tabType: "scenesTab")
      // widgetList[3] is showing characters (tabType: "characterTab")
      // widgetList[4] is showing music list (tabType: "musicTab")
      // widgetList[5] is showing trivia (tabType: "triviaTab")
    
    // find the widget with scenes and time ranges
    var scenesTab;
    for(j=0; j<item.page.sections.center.widgets.widgetList.length; j++){
      scenesTab = (item.page.sections.center.widgets.widgetList[j].tabType == "scenesTab") ? j : scenesTab;
    }

    var sceneData = [];
    for(k=0; k<item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList.length; k++){
      var textMap = item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList[k].textMap;
      var trickPlayTimeRange = item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList[k].trickPlayTimeRange;
      var partitionedChangeList = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].partitionedChangeList;

      // act on partitionedChangeList to build scenes.characters[]
      var characters = [];
      
      // add initial items from initialItemIds
      partitionedChangeList[k].initialItemIds.forEach(function(val, l){
        if(val.split("/")[1] === "name"){
          var name = val.split("/")[val.split("/").length - 1];

          // use synonyms file to replace name
          name = (synonyms.hasOwnProperty(name)) ? synonyms[name].accepted : name;

          if(name != ""){
            characters.push({
              'name': name,
              'start': partitionedChangeList[k].timeRange.startTime,
              'end': partitionedChangeList[k].timeRange.endTime
            });
          }
        }
      });

      // add changes from changesCollection
      partitionedChangeList[k].changesCollection.forEach(function(val, l){
        if(val.itemId.split("/")[1] === "name" && val.changeType === "AddItem" && val.itemId.split("/")[val.itemId.split("/").length-2] !== "trivia"){
          var name = val.itemId.split("/")[val.itemId.split("/").length - 1];

          // use synonyms file to replace name
          name = (synonyms.hasOwnProperty(name)) ? synonyms[name].accepted : name;

          if(name !== ""){
            characters.push({
              'name': name,
              'start': val.timePosition,
              'end': partitionedChangeList[k].timeRange.endTime
            });
          }
        }
      });
      
      // keeping startTime, endTime, and range to ensure match from different sources
      sceneData.push({
        'primary': textMap.PRIMARY,
        'tertiary': textMap.TERTIARY,
        'sceneStart': trickPlayTimeRange.startTime,
        'sceneEnd': trickPlayTimeRange.endTime,
        'changes': partitionedChangeList[k].changesCollection,
        'initialIds': partitionedChangeList[k].initialItemIds,
        'range': partitionedChangeList[k].timeRange,
        'characters': characters
      });
    }
    item.scenes = sceneData;
  })

  console.log("now that the files are loaded... do magic.");

  /* CONFIG SETUP */
  d3.select("svg")
    .attr("width", config.width)
    .attr("height", config.height)
  /* END CONFIG SETUP */

  var allCharacters = []; // array for all characters
  var uniqueCharacters = []; // array for uniqueCharacters
  var episodesData = episodes;
  var matrixObject = {
    "nodes": [],
    "links": []
  }

  for(var i in episodesData){
    // act on scenes
    var scenes = episodesData[i].scenes;
    for(var j in scenes){
      // add characters in scene to allCharacters array
      for (var k in scenes[j].characters){
        if(scenes[j].characters[k].name.length > 0){
          allCharacters.push(scenes[j].characters[k].name);
        }
      }
    }
  }

  // deduplicate the list of characters from scenes
  uniqueCharacters = allCharacters.filter(onlyUnique).sort();

  for(var i in uniqueCharacters){
    matrixObject.nodes.push({
      "name":uniqueCharacters[i],
      "count":0
    })
  }

  var matrix = new Array(uniqueCharacters.length);
  for(i=0; i<uniqueCharacters.length; i++){
    matrix[i] = new Array(uniqueCharacters.length);
    for(j=0; j<uniqueCharacters.length; j++){
      matrix[i][j] = {
        "x": j,
        "y": i,
        "z": 0
      };
    }
  }

  for(var i in episodesData){
    var scenes = episodesData[i].scenes;
    for(var j in scenes){
      for(var k in scenes[j].characters){
        for(var l in scenes[j].characters){
          var m = uniqueCharacters.indexOf(scenes[j].characters[k].name);
          var n = uniqueCharacters.indexOf(scenes[j].characters[l].name);
          // add 1 to the co-occurrence matrix
          matrix[m][n].z++;
          // this count is just used to sort by frequency, not an actual count
          matrixObject.nodes[m].count++;
          matrixObject.nodes[n].count++;
        }
      }
    }
  }

  // build the visualization
  var width = config.width,
    height = config.height,
    margin = config.margin;

  var x = d3.scale.ordinal().rangeBands([0, width]),
    z = d3.scale.linear().domain([0, 4]).clamp(true),
    c = d3.scale.category10().domain(d3.range(10));

var svg = d3.select("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .style("margin-left", -125 + "px")
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.attr("height", height);

  var nodes = matrixObject.nodes,
    n = matrixObject.nodes.length;

  // Precompute the orders.
  var orders = {
    name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].name, nodes[b].name); }),
    count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; }),
    group: d3.range(n).sort(function(a, b) { return nodes[b].group - nodes[a].group; })
  };

  // The default sort order.
  x.domain(orders.name);

  svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height);

  var row = svg.selectAll(".row")
      .data(matrix)
    .enter().append("g")
      .attr("class", "row")
      .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .each(row);

  row.append("line")
      .attr("x2", width);

  row.append("text")
      .attr("x", -6)
      .attr("y", x.rangeBand() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "end")
      .text(function(d, i) { return nodes[i].name; });

  var column = svg.selectAll(".column")
      .data(matrix)
    .enter().append("g")
      .attr("class", "column")
      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

  column.append("line")
      .attr("x1", -width);

  column.append("text")
      .attr("x", 6)
      .attr("y", x.rangeBand() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "start")
      .text(function(d, i) { return nodes[i].name; });

  function row(row) {
    var cell = d3.select(this).selectAll(".cell")
        .data(row.filter(function(d) { return d.z; }))
      .enter().append("rect")
        .attr("class", "cell")
        .attr("x", function(d) { return x(d.x); })
        .attr("width", x.rangeBand())
        .attr("height", x.rangeBand())
        .style("fill-opacity", function(d) { return z(d.z); })
        .style("fill", function(d) { return nodes[d.x].group == nodes[d.y].group ? c(nodes[d.x].group) : null; })
        .append("title")
          .text(function(d){
            var counter = (d.z > 1) ? "s" : "";
            if(d.x == d.y){
              return nodes[d.x].name + " has been in " + d.z + " scene"+counter+".";
            } else {
              return nodes[d.x].name + " and " + nodes[d.y].name + " have been in " + d.z + " scene"+counter+" together.";
            }
          })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout);
  }

  function mouseover(p) {
    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
  }

  function mouseout() {
    d3.selectAll("text").classed("active", false);
  }

  d3.select("#order").on("change", function() {
    clearTimeout(timeout);
    order(this.value);
  });

  function order(value) {
    x.domain(orders[value]);

    var t = svg.transition().duration(2500);

    t.selectAll(".row")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .selectAll(".cell")
        .delay(function(d) { return x(d.x) * 4; })
        .attr("x", function(d) { return x(d.x); });

    t.selectAll(".column")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
  }

  var timeout = setTimeout(function() {
    order("count");
    d3.select("#order").property("selectedIndex", 1);
  }, 5000);

};

    </script>
  </body>
</html>