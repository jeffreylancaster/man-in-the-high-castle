<!DOCTYPE html>
<html>
<!-- from: https://bl.ocks.org/Andrew-Reid/0aedd5f3fb8b099e3e10690bd38bd458 -->
  <head>
    <title>Man in the High Castle: Time Per Character</title>
    <meta charset="UTF-8">
    <meta name="description" content="Man in the High Castle: Time Per Character">
    <meta name="keywords" content="Man in the High Castle, Netflix, X-ray data, Juliana Crain, John Smith, Joe Blake, Frank Frink, Takeshi Kido, Nobusuke Tagomi, Helen Smith, Ed McCarthy, Robert Childan, Nicole Dormer, Hawthorne Abendsen">
    <meta name="author" content="Jeffrey Lancaster">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
    <style>
      .axis .domain {
        display: none;
      }
      .timestamp{
        fill: black;
      }
      body{
        font-family: "Helvetica Neue";
        padding-top: 35px;
      }
      header{
        margin: 15px;
      }
      header img {
        height: 0;
        margin-top: 0;
      }
      header span{
        font-weight: 300;
        font-size: 50px;
      }
      #cta{
        color: #999;
        font-style: italic;
        font-size: 0.8em;
      }
      #description{
        width: 100%;
        max-width: 1000px;
        margin: 0 15px;
        color: #999;
        font-size: 0.8em;
      }
      #description a{
        text-decoration: none;
      }
      @import url(https://bost.ocks.org/mike/style.css);
      .background {
        fill: #eee;
      }
      line {
        stroke: #fff;
      }
      text{
        font-size: 0.65em;
      }
      text.active {
        fill: red;
      }
      svg{
        padding-left: 200px;
      }
      .cell{
        fill: #CCC;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>
        <img>
        <span></span>
      </h1>
    </header>
    <div id="description">
      <h2>Playing with Amazon X-Ray data.</h2>

      <p>Code and data for this chart are on <a href="https://github.com/jeffreylancaster/man-in-the-high-castle" target="_blank">github</a>, and a description of the impetus to this project is on <a href="https://medium.com/@jeffrey.lancaster/the-ultimate-game-of-thrones-dataset-a100c0cf35fb" target="_blank">Medium</a>. h/t to <a href="https://www.curiousgnu.com/movie-character-screen-time" target="_blank">curiousgnu.com</a> for X-ray data extraction.</p>

      <p><i>Coming soon: notes on working with X-ray data and handling inconsistencies therein.</i></p>

      <p>Comments and suggestions are welcome on github, Medium, or <a href="mailto: jeffrey@jeffreylancaster.com" target="_blank">here</a>.</p>

      <p>Order: <select id="order">
        <option value="name">by Name</option>
        <option value="count">by Frequency</option>
        <!-- <option value="group">by Cluster</option> -->
      </select></p>
    </div>
    <svg></svg>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v2.min.js"></script>
    <script>
/* HELPFUL FUNCTIONS */

// to convert scene start/end times into seconds
function sec(timeString){
  var sec = 0;
  if (timeString.length == 0) return sec;
  var splitArray = timeString.split(":");
  sec = 3600*parseFloat(splitArray[0])+60*parseFloat(splitArray[1])+parseFloat(splitArray[2]);
  return sec;
}

// to convert milliseconds into hh:mm:ss
function millisecondsToHMS(d) {
  var date = new Date(null);
  date.setMilliseconds(d); // specify value for MILLISECONDS here
  return date.toISOString().substr(11, 8);
}

// to convert seconds into hh:mm:ss
function secondsToHMS(d) {
  var date = new Date(null);
  date.setSeconds(d); // specify value for SECONDS here
  return date.toISOString().substr(11, 8);
}

// to dedpulicate an array
function onlyUnique(value, index, self) { 
  return self.indexOf(value) === index;
}


/* VARIABLES AND CONFIGURATION */


// variable containers for imported data
var s1e1, s1e2, s1e3,s1e4,s1e5,s1e6,s1e7,s1e8,s1e9,s1e10,s2e1,s2e2,s2e3,s2e4,s2e5,s2e6,s2e7,s2e8,s2e9,s2e10,s3e1,s3e2,s3e3,s3e4,s3e5,s3e6,s3e7,s3e8,s3e9,s3e10;
var config, synonyms;
var episodes = [];

/* IMPORT DATA */
$.when(
  $.getJSON('../data/man-in-the-high-castle-s1-e1-xray.json', function(data){s1e1 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 1}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e2-xray.json', function(data){s1e2 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 2}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e3-xray.json', function(data){s1e3 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 3}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e4-xray.json', function(data){s1e4 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 4}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e5-xray.json', function(data){s1e5 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 5}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e6-xray.json', function(data){s1e6 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 6}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e7-xray.json', function(data){s1e7 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 7}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e8-xray.json', function(data){s1e8 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 8}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e9-xray.json', function(data){s1e9 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 9}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s1-e10-xray.json', function(data){s1e10 = Object.assign({}, {'seasonNum': 1, 'episodeNum': 10}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e1-xray.json', function(data){s2e1 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 1}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e2-xray.json', function(data){s2e2 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 2}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e3-xray.json', function(data){s2e3 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 3}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e4-xray.json', function(data){s2e4 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 4}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e5-xray.json', function(data){s2e5 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 5}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e6-xray.json', function(data){s2e6 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 6}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e7-xray.json', function(data){s2e7 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 7}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e8-xray.json', function(data){s2e8 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 8}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e9-xray.json', function(data){s2e9 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 9}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s2-e10-xray.json', function(data){s2e10 = Object.assign({}, {'seasonNum': 2, 'episodeNum': 10}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e1-xray.json', function(data){s3e1 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 1}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e2-xray.json', function(data){s3e2 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 2}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e3-xray.json', function(data){s3e3 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 3}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e4-xray.json', function(data){s3e4 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 4}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e5-xray.json', function(data){s3e5 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 5}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e6-xray.json', function(data){s3e6 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 6}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e7-xray.json', function(data){s3e7 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 7}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e8-xray.json', function(data){s3e8 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 8}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e9-xray.json', function(data){s3e9 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 9}, data);}),
  $.getJSON('../data/man-in-the-high-castle-s3-e10-xray.json', function(data){s3e10 = Object.assign({}, {'seasonNum': 3, 'episodeNum': 10}, data);}),
  $.getJSON("../data/synonyms.json", function(data) {
    synonyms = data;
    for(var i in synonyms){
      for(j=0; j<synonyms[i].aliases.length; j++){
        synonyms[synonyms[i].aliases[j]] = {};
        synonyms[synonyms[i].aliases[j]].accepted = synonyms[i].accepted; 
      }
    }
    console.log("synonyms.json loaded");
  }),
  $.getJSON("../data/config.json", function(data) {
    config = data.config;
    console.log("config.json loaded");
  })
  .fail(function() {console.error("config.json not loaded");})
).then(function() {
  // massage the data
  episodes = [s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10];
  episodes.forEach(function(item, i){
    // add all x-ray items from episode
    var items = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].items; // a list of all characters, soundtrack, trivia, etc.
    item.items = items;
    
    // 1 if season 1, 2; 2 if season 3
    // season 1, 2
      // widgetList[0] is showing cast (tabType: "castTab")
      // widgetList[1] is showing scenes and time ranges (tabType: "scenesTab")
      // widgetList[2] is showing characters (tabType: "characterTab")
      // widgetList[3] is showing music list (tabType: "musicTab")
      // widgetList[4] is showing trivia (tabType: "triviaTab")
    // season 3
      // widgetList[0] is showing photos and videos gallery (tabType: "galleryTab")
      // widgetList[1] is showing cast (tabType: "castTab")
      // widgetList[2] is showing scenes and time ranges (tabType: "scenesTab")
      // widgetList[3] is showing characters (tabType: "characterTab")
      // widgetList[4] is showing music list (tabType: "musicTab")
      // widgetList[5] is showing trivia (tabType: "triviaTab")
    
    // find the widget with scenes and time ranges
    var scenesTab;
    for(j=0; j<item.page.sections.center.widgets.widgetList.length; j++){
      scenesTab = (item.page.sections.center.widgets.widgetList[j].tabType == "scenesTab") ? j : scenesTab;
    }

    var sceneData = [];
    for(k=0; k<item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList.length; k++){
      var textMap = item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList[k].textMap;
      var trickPlayTimeRange = item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList[k].trickPlayTimeRange;
      var partitionedChangeList = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].partitionedChangeList;

      // act on partitionedChangeList to build scenes.characters[]
      var characters = [];
      
      // add initial items from initialItemIds
      partitionedChangeList[k].initialItemIds.forEach(function(val, l){
        if(val.split("/")[1] === "name"){
          var name = val.split("/")[val.split("/").length - 1];

          // use synonyms file to replace name
          name = (synonyms.hasOwnProperty(name)) ? synonyms[name].accepted : name;

          if(name != ""){
            characters.push({
              'name': name,
              'start': partitionedChangeList[k].timeRange.startTime,
              'end': partitionedChangeList[k].timeRange.endTime
            });
          }
        }
      });

      // add changes from changesCollection
      partitionedChangeList[k].changesCollection.forEach(function(val, l){
        if(val.itemId.split("/")[1] === "name" && val.changeType === "AddItem" && val.itemId.split("/")[val.itemId.split("/").length-2] !== "trivia"){
          var name = val.itemId.split("/")[val.itemId.split("/").length - 1];

          // use synonyms file to replace name
          name = (synonyms.hasOwnProperty(name)) ? synonyms[name].accepted : name;

          if(name !== ""){
            characters.push({
              'name': name,
              'start': val.timePosition,
              'end': partitionedChangeList[k].timeRange.endTime
            });
          }
        }
      });
      
      // keeping startTime, endTime, and range to ensure match from different sources
      sceneData.push({
        'primary': textMap.PRIMARY,
        'tertiary': textMap.TERTIARY,
        'sceneStart': trickPlayTimeRange.startTime,
        'sceneEnd': trickPlayTimeRange.endTime,
        'changes': partitionedChangeList[k].changesCollection,
        'initialIds': partitionedChangeList[k].initialItemIds,
        'range': partitionedChangeList[k].timeRange,
        'characters': characters
      });
    }
    item.scenes = sceneData;
  })
}).then(function() {
  console.log("now that the files are loaded... do magic.");

  /* CONFIG SETUP */
  $("h1 > img").css({"height": config.logo.height, "vertical-align": "middle", "margin-top": config.logo.marginTop}).attr("src", "../img/"+config.logo.src);
  $("h1 > span").html(" - "+config.characterMatrix.title);
  $("svg").attr({width: config.characterMatrix.svg.width, height: config.characterMatrix.svg.height});
  /* END CONFIG SETUP */

  var allCharacters = []; // array for all characters
  var uniqueCharacters = []; // array for uniqueCharacters
  var episodesData = episodes;
  var matrixObject = {
    "nodes": [],
    "links": []
  }

  for(var i in episodesData){
    // act on scenes
    var scenes = episodesData[i].scenes;
    for(var j in scenes){
      // add characters in scene to allCharacters array
      for (var k in scenes[j].characters){
        if(scenes[j].characters[k].name.length > 0){
          allCharacters.push(scenes[j].characters[k].name);
        }
      }
    }
  }

  // deduplicate the list of characters from scenes
  uniqueCharacters = allCharacters.filter(onlyUnique).sort();

  for(var i in uniqueCharacters){
    matrixObject.nodes.push({
      "name":uniqueCharacters[i],
      "count":0
    })
  }

  var matrix = new Array(uniqueCharacters.length);
  for(i=0; i<uniqueCharacters.length; i++){
    matrix[i] = new Array(uniqueCharacters.length);
    for(j=0; j<uniqueCharacters.length; j++){
      matrix[i][j] = {
        "x": j,
        "y": i,
        "z": 0
      };
    }
  }

  for(var i in episodesData){
    var scenes = episodesData[i].scenes;
    for(var j in scenes){
      for(var k in scenes[j].characters){
        for(var l in scenes[j].characters){
          var m = uniqueCharacters.indexOf(scenes[j].characters[k].name);
          var n = uniqueCharacters.indexOf(scenes[j].characters[l].name);
          // add 1 to the co-occurrence matrix
          matrix[m][n].z++;
          // this count is just used to sort by frequency, not an actual count
          matrixObject.nodes[m].count++;
          matrixObject.nodes[n].count++;
        }
      }
    }
  }

  // build the visualization
  var width, height;
    
  width = config.characterMatrix.svg.width;
  height = config.characterMatrix.svg.height;

  var x = d3.scale.ordinal().rangeBands([0, width]),
    z = d3.scale.linear().domain([0, 4]).clamp(true),
    c = d3.scale.category10().domain(d3.range(10));

var svg = d3.select("svg")
    .attr("width", width + config.characterMatrix.svg.margin.left + config.characterMatrix.svg.margin.right)
    .attr("height", height + config.characterMatrix.svg.margin.top + config.characterMatrix.svg.margin.bottom)
    .style("margin-left", -config.characterMatrix.svg.margin.left + "px")
  .append("g")
    .attr("transform", "translate(" + config.characterMatrix.svg.margin.left + "," + config.characterMatrix.svg.margin.top + ")");

  var nodes = matrixObject.nodes,
    n = matrixObject.nodes.length;

  // Precompute the orders.
  var orders = {
    name: d3.range(n).sort(function(a, b) { return d3.ascending(nodes[a].name, nodes[b].name); }),
    count: d3.range(n).sort(function(a, b) { return nodes[b].count - nodes[a].count; }),
    group: d3.range(n).sort(function(a, b) { return nodes[b].group - nodes[a].group; })
  };

  // The default sort order.
  x.domain(orders.name);

  svg.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height);

  var row = svg.selectAll(".row")
      .data(matrix)
    .enter().append("g")
      .attr("class", "row")
      .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .each(row);

  row.append("line")
      .attr("x2", width);

  row.append("text")
      .attr("x", -6)
      .attr("y", x.rangeBand() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "end")
      .text(function(d, i) { return nodes[i].name; });

  var column = svg.selectAll(".column")
      .data(matrix)
    .enter().append("g")
      .attr("class", "column")
      .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });

  column.append("line")
      .attr("x1", -width);

  column.append("text")
      .attr("x", 6)
      .attr("y", x.rangeBand() / 2)
      .attr("dy", ".32em")
      .attr("text-anchor", "start")
      .text(function(d, i) { return nodes[i].name; });

  function row(row) {
    var cell = d3.select(this).selectAll(".cell")
        .data(row.filter(function(d) { return d.z; }))
      .enter().append("rect")
        .attr("class", "cell")
        .attr("x", function(d) { return x(d.x); })
        .attr("width", x.rangeBand())
        .attr("height", x.rangeBand())
        .style("fill-opacity", function(d) { return z(d.z); })
        .style("fill", function(d) { return nodes[d.x].group == nodes[d.y].group ? c(nodes[d.x].group) : null; })
        .append("title")
          .text(function(d){
            var counter = (d.z > 1) ? "s" : "";
            if(d.x == d.y){
              return nodes[d.x].name + " has been in " + d.z + " scene"+counter+".";
            } else {
              return nodes[d.x].name + " and " + nodes[d.y].name + " have been in " + d.z + " scene"+counter+" together.";
            }
          })
        .on("mouseover", mouseover)
        .on("mouseout", mouseout);
  }

  function mouseover(p) {
    d3.selectAll(".row text").classed("active", function(d, i) { return i == p.y; });
    d3.selectAll(".column text").classed("active", function(d, i) { return i == p.x; });
  }

  function mouseout() {
    d3.selectAll("text").classed("active", false);
  }

  d3.select("#order").on("change", function() {
    clearTimeout(timeout);
    order(this.value);
  });

  function order(value) {
    x.domain(orders[value]);

    var t = svg.transition().duration(2500);

    t.selectAll(".row")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(0," + x(i) + ")"; })
      .selectAll(".cell")
        .delay(function(d) { return x(d.x) * 4; })
        .attr("x", function(d) { return x(d.x); });

    t.selectAll(".column")
        .delay(function(d, i) { return x(i) * 4; })
        .attr("transform", function(d, i) { return "translate(" + x(i) + ")rotate(-90)"; });
  }

  var timeout = setTimeout(function() {
    order("count");
    d3.select("#order").property("selectedIndex", 1).node().focus();
  }, 5000);

});

    </script>
  </body>
</html>