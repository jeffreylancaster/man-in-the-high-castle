<!DOCTYPE html>
<html>
  <head>
    <title>Man in the High Castle: Time Per Character</title>
    <meta charset="UTF-8">
    <meta name="description" content="Man in the High Castle: Time Per Character">
    <meta name="author" content="Jeffrey Lancaster">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
  </head>
  <body>
    <svg></svg>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
/* HELPFUL FUNCTIONS */

// to convert scene start/end times into seconds
function sec(timeString){
  var sec = 0;
  if (timeString.length == 0) return sec;
  var splitArray = timeString.split(":");
  sec = 3600*parseFloat(splitArray[0])+60*parseFloat(splitArray[1])+parseFloat(splitArray[2]);
  return sec;
}

// to convert milliseconds into hh:mm:ss
function millisecondsToHMS(d) {
  var date = new Date(null);
  date.setMilliseconds(d); // specify value for MILLISECONDS here
  return date.toISOString().substr(11, 8);
}

// to convert seconds into hh:mm:ss
function secondsToHMS(d) {
  var date = new Date(null);
  date.setSeconds(d); // specify value for SECONDS here
  return date.toISOString().substr(11, 8);
}

// to dedpulicate an array
function onlyUnique(value, index, self) { 
  return self.indexOf(value) === index;
}


var config = {
  "title": "Supercut Duration",
  "width":960,
  "height":6400,
  "margin":{
    "top": 10,
    "right": 40,
    "bottom": 0,
    "left": 180
  },
  "legendOffset": {
    "x":20,
    "y":20
  },
  "barHeight": 20
}

/* IMPORT DATA */
d3.queue()
  .defer(d3.json, '../data/synonyms.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e10-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e10-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e10-xray.json')
  .await(ready);

function ready(error, synonyms, s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10) {
  if (error) throw error;
  console.log("now that the files are loaded... do magic.");

  s1e1 = {...s1e1, 'seasonNum': 1, 'episodeNum': 1};
  s1e2 = {...s1e2, 'seasonNum': 1, 'episodeNum': 2};
  s1e3 = {...s1e3, 'seasonNum': 1, 'episodeNum': 3};
  s1e4 = {...s1e4, 'seasonNum': 1, 'episodeNum': 4};
  s1e5 = {...s1e5, 'seasonNum': 1, 'episodeNum': 5};
  s1e6 = {...s1e6, 'seasonNum': 1, 'episodeNum': 6};
  s1e7 = {...s1e7, 'seasonNum': 1, 'episodeNum': 7};
  s1e8 = {...s1e8, 'seasonNum': 1, 'episodeNum': 8};
  s1e9 = {...s1e9, 'seasonNum': 1, 'episodeNum': 9};
  s1e10 = {...s1e10, 'seasonNum': 1, 'episodeNum': 10};
  s2e1 = {...s2e1, 'seasonNum': 2, 'episodeNum': 1};
  s2e2 = {...s2e2, 'seasonNum': 2, 'episodeNum': 2};
  s2e3 = {...s2e3, 'seasonNum': 2, 'episodeNum': 3};
  s2e4 = {...s2e4, 'seasonNum': 2, 'episodeNum': 4};
  s2e5 = {...s2e5, 'seasonNum': 2, 'episodeNum': 5};
  s2e6 = {...s2e6, 'seasonNum': 2, 'episodeNum': 6};
  s2e7 = {...s2e7, 'seasonNum': 2, 'episodeNum': 7};
  s2e8 = {...s2e8, 'seasonNum': 2, 'episodeNum': 8};
  s2e9 = {...s2e9, 'seasonNum': 2, 'episodeNum': 9};
  s2e10 = {...s2e10, 'seasonNum': 2, 'episodeNum': 10};
  s3e1 = {...s3e1, 'seasonNum': 3, 'episodeNum': 1};
  s3e2 = {...s3e2, 'seasonNum': 3, 'episodeNum': 2};
  s3e3 = {...s3e3, 'seasonNum': 3, 'episodeNum': 3};
  s3e4 = {...s3e4, 'seasonNum': 3, 'episodeNum': 4};
  s3e5 = {...s3e5, 'seasonNum': 3, 'episodeNum': 5};
  s3e6 = {...s3e6, 'seasonNum': 3, 'episodeNum': 6};
  s3e7 = {...s3e7, 'seasonNum': 3, 'episodeNum': 7};
  s3e8 = {...s3e8, 'seasonNum': 3, 'episodeNum': 8};
  s3e9 = {...s3e9, 'seasonNum': 3, 'episodeNum': 9};
  s3e10 = {...s3e10, 'seasonNum': 3, 'episodeNum': 10};

  // massage the data
  var episodes = [s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10];
  episodes.forEach(function(item, i){
    // add all x-ray items from episode
    var items = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].items; // a list of all characters, soundtrack, trivia, etc.
    item.items = items;
    
    // 1 if season 1, 2; 2 if season 3
    // season 1, 2
      // widgetList[0] is showing cast (tabType: "castTab")
      // widgetList[1] is showing scenes and time ranges (tabType: "scenesTab")
      // widgetList[2] is showing characters (tabType: "characterTab")
      // widgetList[3] is showing music list (tabType: "musicTab")
      // widgetList[4] is showing trivia (tabType: "triviaTab")
    // season 3
      // widgetList[0] is showing photos and videos gallery (tabType: "galleryTab")
      // widgetList[1] is showing cast (tabType: "castTab")
      // widgetList[2] is showing scenes and time ranges (tabType: "scenesTab")
      // widgetList[3] is showing characters (tabType: "characterTab")
      // widgetList[4] is showing music list (tabType: "musicTab")
      // widgetList[5] is showing trivia (tabType: "triviaTab")
    
    // find the widget with scenes and time ranges
    var scenesTab;
    for(j=0; j<item.page.sections.center.widgets.widgetList.length; j++){
      scenesTab = (item.page.sections.center.widgets.widgetList[j].tabType == "scenesTab") ? j : scenesTab;
    }

    var sceneData = [];
    for(k=0; k<item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList.length; k++){
      var textMap = item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList[k].textMap;
      var trickPlayTimeRange = item.page.sections.center.widgets.widgetList[scenesTab].widgets.widgetList[0].items.itemList[k].trickPlayTimeRange;
      var partitionedChangeList = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].partitionedChangeList;

      // act on partitionedChangeList to build scenes.characters[]
      var characters = [];
      
      // add initial items from initialItemIds
      partitionedChangeList[k].initialItemIds.forEach(function(val, l){
        if(val.split("/")[1] === "name"){
          var name = val.split("/")[val.split("/").length - 1];

          // use synonyms file to replace name
          name = (synonyms.hasOwnProperty(name)) ? synonyms[name].accepted : name;

          characters.push({
            'name': name,
            'start': partitionedChangeList[k].timeRange.startTime,
            'end': partitionedChangeList[k].timeRange.endTime
          });
        }
      });

      // add changes from changesCollection
      partitionedChangeList[k].changesCollection.forEach(function(val, l){
        if(val.itemId.split("/")[1] === "name" && val.changeType === "AddItem" && val.itemId.split("/")[val.itemId.split("/").length-2] !== "trivia"){
          var name = val.itemId.split("/")[val.itemId.split("/").length - 1];

          // use synonyms file to replace name
          name = (synonyms.hasOwnProperty(name)) ? synonyms[name].accepted : name;

          characters.push({
            'name': name,
            'start': val.timePosition,
            'end': partitionedChangeList[k].timeRange.endTime
          });
        }
      });
      
      // keeping startTime, endTime, and range to ensure match from different sources
      sceneData.push({
        'primary': textMap.PRIMARY,
        'tertiary': textMap.TERTIARY,
        'sceneStart': trickPlayTimeRange.startTime,
        'sceneEnd': trickPlayTimeRange.endTime,
        'changes': partitionedChangeList[k].changesCollection,
        'initialIds': partitionedChangeList[k].initialItemIds,
        'range': partitionedChangeList[k].timeRange,
        'characters': characters
      });
    }
    item.scenes = sceneData;
  })

  console.log(episodes);
  console.log("now that the files are loaded... do magic.");

  /* CONFIG SETUP */
  d3.select("svg")
    .attr("width", config.width)
    .attr("height", config.height)
  /* END CONFIG SETUP */

  var allCharacters = []; // array for all characters
  var uniqueCharacters = []; // array for uniqueCharacters
  var episodesData = episodes;

  for (var i in episodesData) {
    // act on scenes
    var scenes = episodesData[i].scenes;
    for (var j in scenes){
      // calculate length of scene in milliseconds
      var sceneLength = Math.abs(scenes[j].sceneEnd - scenes[j].sceneStart);
      
      scenes[j].length = sceneLength;

      // add characters in scene to allCharacters array
      for (var k in scenes[j].characters){
        if(scenes[j].characters[k].name.length > 0){
          allCharacters.push(scenes[j].characters[k].name);
        }
      }
    }
  }


  // deduplicate the list of characters from scenes
  uniqueCharacters = allCharacters.filter(onlyUnique).sort();

  // rebuild uniqueCharacters array
  for(i=0; i<uniqueCharacters.length; i++){
    uniqueCharacters[i] = {"name":uniqueCharacters[i], "1":0, "2":0, "3":0, "4":0, "5":0, "6":0, "7":0, "8":0};
  }

  // sum scene lengths for characters in scenes
  for(var i in episodesData) {
    for(var j in episodesData[i].scenes){
      for(var k in episodesData[i].scenes[j].characters){
        for(var l in uniqueCharacters){
          if(episodesData[i].scenes[j].characters[k].name == uniqueCharacters[l].name){
            uniqueCharacters[l][episodesData[i].seasonNum] += episodesData[i].scenes[j].length;
          }
        } 
      }
    }
  }

  // build the visualization
  var data = uniqueCharacters;
  var barHeight = config.barHeight;

  var svg = d3.select("svg"),
      margin = config.margin,
      width = +svg.attr("width") - margin.left - margin.right,
      height = barHeight*data.length + margin.top + margin.bottom,
      g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.attr("height", height);

  var y = d3.scaleBand() 
      .rangeRound([0, height])
      .paddingInner(0.15)
      .align(0.1);

  var x = d3.scaleLinear()
      .rangeRound([0, width]);

  var z = d3.scaleOrdinal() //  or d3.schemeCategory20c between () and no .range
      .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00", "#FEC574"]);

  var keys = d3.keys(data[0]).slice(0,3);

  for (i=0; i<data.length; i++){
    var t=0;
    for(j=0; j<keys.length; j++){
      t += data[i][keys[j]];
    }
    data[i].total = t;
  } 

  data.sort(function(a, b) { return a.total - b.total; }).reverse();
  y.domain(data.map(function(d) { return d.name; }));
  x.domain([0, d3.max(data, function(d) { return d.total; })]).nice();
  z.domain(keys);

  g.append("g")
    .selectAll("g")
    .data(d3.stack().keys(keys)(data))
    .enter().append("g")
      .attr("fill", function(d) { return z(d.key); })
    .selectAll("rect")
    .data(function(d) { return d; })
    .enter().append("rect")
      .attr("y", function(d) { return y(d.data.name); })
      .attr("x", function(d) { return x(d[0]); })
      .attr("width", function(d) { return x(d[1]) - x(d[0]); })
      .attr("height", y.bandwidth());

  g.selectAll("g")
    .data(d3.stack().keys(keys)(data))
    .append("svg:title")
      .text(function(d,i) {
        // not sure why this shift needs to happen...
        if(i == 0){
          return "Season "+keys[keys.length-1]
        } else {
          return "Season "+keys[i-1]
        };
      });

  g.append("g")
    .attr("class", "axis")
    .attr("transform", "translate(0,0)")
    .call(d3.axisLeft(y));

  g.selectAll(".axis")
    .selectAll(".tick")
    .data(data)
    .append("text")
    .attr("class", "timestamp")
    .attr("dy", "0.35em")
    .attr("dx", function(d){ return x(d.total) + 5; })
    .attr("text-anchor", "start")
    .text(function(d){ return millisecondsToHMS(d.total); });

  var legend = g.append("g")
    .attr("font-family", "sans-serif")
    .attr("font-size", 10)
    .attr("text-anchor", "end")
    .attr("transform", function(d, i) { return `translate(${config.legendOffset.x}, ${config.legendOffset.y})`})
    .selectAll("g")
    .data(keys.slice())
    .enter().append("g")
    .attr("transform", function(d, i) { return "translate(0," + i * 20 + ")"; });

  legend.append("rect")
    .attr("x", width - 19)
    .attr("width", 19)
    .attr("height", 19)
    .attr("fill", z);

  legend.append("text")
    .attr("x", width - 24)
    .attr("y", 9.5)
    .attr("dy", "0.32em")
    .text(function(d) { return "Season " + d; });

};

    </script>
  </body>
</html>