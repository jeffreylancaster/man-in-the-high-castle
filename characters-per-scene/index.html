<!DOCTYPE html>
<html>
  <head>
    <title>Man in the High Castle: Characters Per Scene</title>
    <meta charset="UTF-8">
    <meta name="description" content="Man in the High Castle: Characters Per Scene">
    <meta name="author" content="Jeffrey Lancaster">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../style.css">
  </head>
  <body>
    <p style="margin-left: 20px;">
      <button class="center">Center</button>
      <button class="baseline">Baseline</button>
    </p>
    <svg></svg>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <!-- for d3.queue() using d3.v5 -->
    <script src="https://d3js.org/d3-collection.v1.min.js"></script>
    <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
    <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
    <script src="https://d3js.org/d3-request.v1.min.js"></script>
    <script src="https://d3js.org/d3-queue.v3.min.js"></script>
    <script>
/* HELPFUL FUNCTIONS */

// to convert scene start/end times into seconds
function sec(timeString){
  var sec = 0;
  if (timeString.length == 0) return sec;
  var splitArray = timeString.split(":");
  sec = 3600*parseFloat(splitArray[0])+60*parseFloat(splitArray[1])+parseFloat(splitArray[2]);
  return sec;
}

// to convert milliseconds into hh:mm:ss
function millisecondsToHMS(d) {
  var date = new Date(null);
  date.setMilliseconds(d); // specify value for MILLISECONDS here
  return date.toISOString().substr(11, 8);
}

// to convert seconds into hh:mm:ss
function secondsToHMS(d) {
  var date = new Date(null);
  date.setSeconds(d); // specify value for SECONDS here
  return date.toISOString().substr(11, 8);
}

// to dedpulicate an array
function onlyUnique(value, index, self) { 
  return self.indexOf(value) === index;
}


var config = {
  "title": "Characters Per Scene",
  "width":2000,
  "height":500,
  "margin":{
    "top": 10,
    "right": 40,
    "bottom": 30,
    "left": 40
  },
  "barHeight": 20
}

/* IMPORT DATA */
d3.queue()
  .defer(d3.json, '../data/synonyms.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s1-e10-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s2-e10-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e1-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e2-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e3-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e4-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e5-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e6-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e7-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e8-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e9-xray.json')
  .defer(d3.json, '../data/man-in-the-high-castle-s3-e10-xray.json')
  .await(ready);

function ready(error, synonyms, s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10) {
  if (error) throw error;
  console.log("now that the files are loaded... do magic.");

  s1e1 = {...s1e1, 'seasonNum': 1, 'episodeNum': 1};
  s1e2 = {...s1e2, 'seasonNum': 1, 'episodeNum': 2};
  s1e3 = {...s1e3, 'seasonNum': 1, 'episodeNum': 3};
  s1e4 = {...s1e4, 'seasonNum': 1, 'episodeNum': 4};
  s1e5 = {...s1e5, 'seasonNum': 1, 'episodeNum': 5};
  s1e6 = {...s1e6, 'seasonNum': 1, 'episodeNum': 6};
  s1e7 = {...s1e7, 'seasonNum': 1, 'episodeNum': 7};
  s1e8 = {...s1e8, 'seasonNum': 1, 'episodeNum': 8};
  s1e9 = {...s1e9, 'seasonNum': 1, 'episodeNum': 9};
  s1e10 = {...s1e10, 'seasonNum': 1, 'episodeNum': 10};
  s2e1 = {...s2e1, 'seasonNum': 2, 'episodeNum': 1};
  s2e2 = {...s2e2, 'seasonNum': 2, 'episodeNum': 2};
  s2e3 = {...s2e3, 'seasonNum': 2, 'episodeNum': 3};
  s2e4 = {...s2e4, 'seasonNum': 2, 'episodeNum': 4};
  s2e5 = {...s2e5, 'seasonNum': 2, 'episodeNum': 5};
  s2e6 = {...s2e6, 'seasonNum': 2, 'episodeNum': 6};
  s2e7 = {...s2e7, 'seasonNum': 2, 'episodeNum': 7};
  s2e8 = {...s2e8, 'seasonNum': 2, 'episodeNum': 8};
  s2e9 = {...s2e9, 'seasonNum': 2, 'episodeNum': 9};
  s2e10 = {...s2e10, 'seasonNum': 2, 'episodeNum': 10};
  s3e1 = {...s3e1, 'seasonNum': 3, 'episodeNum': 1};
  s3e2 = {...s3e2, 'seasonNum': 3, 'episodeNum': 2};
  s3e3 = {...s3e3, 'seasonNum': 3, 'episodeNum': 3};
  s3e4 = {...s3e4, 'seasonNum': 3, 'episodeNum': 4};
  s3e5 = {...s3e5, 'seasonNum': 3, 'episodeNum': 5};
  s3e6 = {...s3e6, 'seasonNum': 3, 'episodeNum': 6};
  s3e7 = {...s3e7, 'seasonNum': 3, 'episodeNum': 7};
  s3e8 = {...s3e8, 'seasonNum': 3, 'episodeNum': 8};
  s3e9 = {...s3e9, 'seasonNum': 3, 'episodeNum': 9};
  s3e10 = {...s3e10, 'seasonNum': 3, 'episodeNum': 10};

  // massage the data
  var episodes = [s1e1, s1e2, s1e3, s1e4, s1e5, s1e6, s1e7, s1e8, s1e9, s1e10, s2e1, s2e2, s2e3, s2e4, s2e5, s2e6, s2e7, s2e8, s2e9, s2e10, s3e1, s3e2, s3e3, s3e4, s3e5, s3e6, s3e7, s3e8, s3e9, s3e10];
  episodes.forEach(function(item, i){
    // 1 if season 1, 2; 2 if season 3
    var swap = item.page.sections.center.widgets.widgetList.length % 4;

    var sceneData = [];
    for(k=0; k<item.page.sections.center.widgets.widgetList[swap].widgets.widgetList[0].items.itemList.length; k++){
      var textMap = item.page.sections.center.widgets.widgetList[swap].widgets.widgetList[0].items.itemList[k].textMap;
      var trickPlayTimeRange = item.page.sections.center.widgets.widgetList[swap].widgets.widgetList[0].items.itemList[k].trickPlayTimeRange;
      var partitionedChangeList = item.page.sections.left.widgets.widgetList[0].widgets.widgetList[1].partitionedChangeList;

      // act on partitionedChangeList to build scenes.characters[]
      var characters = [];
      
      // add initial items from initialItemIds
      partitionedChangeList[k].initialItemIds.forEach(function(val, l){
        if(val.split("/")[1] === "name"){
          var name = val.split("/")[val.split("/").length - 1];

          // use synonyms file to replace name
          for(var i in synonyms){
            synonyms[i].aliases.forEach(function(alias, index){
              if(alias === name){
                name = synonyms[i].accepted;
              }
            });
          }

          characters.push({
            'name': name,
            'start': partitionedChangeList[k].timeRange.startTime,
            'end': partitionedChangeList[k].timeRange.endTime
          });
        }
      });

      // add changes from changesCollection
      partitionedChangeList[k].changesCollection.forEach(function(val, l){
        if(val.itemId.split("/")[1] === "name" && val.changeType === "AddItem" && val.itemId.split("/")[val.itemId.split("/").length-2] !== "trivia"){
          var name = val.itemId.split("/")[val.itemId.split("/").length - 1];

          // use synonyms file to replace name
          for(var i in synonyms){
            synonyms[i].aliases.forEach(function(alias, index){
              if(alias === name){
                name = synonyms[i].accepted;
              }
            });
          }

          characters.push({
            'name': name,
            'start': val.timePosition,
            'end': partitionedChangeList[k].timeRange.endTime
          });
        }
      });
      
      // keeping startTime, endTime, and range to ensure match from different sources
      sceneData.push({
        'primary': textMap.PRIMARY,
        'tertiary': textMap.TERTIARY,
        'sceneStart': trickPlayTimeRange.startTime,
        'sceneEnd': trickPlayTimeRange.endTime,
        'changes': partitionedChangeList[k].changesCollection,
        'initialIds': partitionedChangeList[k].initialItemIds,
        'range': partitionedChangeList[k].timeRange,
        'characters': characters
      });
    }

    item.scenes = sceneData;
  })

  console.log(episodes);
  console.log("now that the files are loaded... do magic.");

  /* CONFIG SETUP */
  d3.select("svg")
    .attr("width", config.width)
    .attr("height", config.height)
  /* END CONFIG SETUP */

  var allCharacters = []; // array for all characters
  var uniqueCharacters = []; // array for uniqueCharacters
  var totalTime = 0;
  var charactersArray = [];
  var seasons = [];
  var end = 0;
  var allScenes = [];
  var exclude = ["Amazon Original", "Studio Logo", "Opening Credits", "End Credits"];
  var episodesData = episodes;
        
  for (var i in episodesData) {
    // act on scenes
    var scenes = episodesData[i].scenes;
    for (var j in scenes){
      // calculate length of scene in seconds
      var sceneLength = Math.abs(scenes[j].sceneEnd - scenes[j].sceneStart);

      if(exclude.indexOf(scenes[j].primary.split(".")[1].trim()) > -1){
        // skip

      } else {
        // append absolute value of scene start in milliseconds
        scenes[j].absStartmSec = totalTime;
        // append absolute value of scene end in milliseconds
        scenes[j].absEndmSec = totalTime + sceneLength;
        // store the last absEndSec as end
        end = scenes[j].absEndmSec;
        // add scene length to total time
        totalTime += sceneLength;

        allScenes.push(episodesData[i].scenes[j]);
        allScenes[allScenes.length - 1].season = episodesData[i].seasonNum;
      }

      // add characters in scene to allCharacters array
      for (var k in scenes[j].characters){
        if(scenes[j].characters[k].name.length > 0){
          allCharacters.push(scenes[j].characters[k].name);
        }
      }
    }
  }

  for(var i in allScenes){
    allScenes[i].characters.sort((a,b) => (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0));
    for(var j in allScenes[i].characters){
      allScenes[i].characters[j].index = parseInt(j);
      allScenes[i].characters[j].total = allScenes[i].characters.length-1;
    }
  }

  // deduplicate the list of characters from scenes
  uniqueCharacters = allCharacters.filter(onlyUnique).sort();

  // calculate the maximum number of characters in a scene
  var maxCharacters = 0;
  for(var i in allScenes){
    maxCharacters = (allScenes[i].characters.length > maxCharacters) ? allScenes[i].characters.length : maxCharacters;
  }  

  // build the visualization
  var data = allScenes;
  var barHeight = config.barHeight;

  var svg = d3.select("svg"),
      margin = config.margin,
      width = +svg.attr("width") - margin.left - margin.right,
      // height = barHeight*data.length + margin.top + margin.bottom,
      height = barHeight * maxCharacters,
      g = svg.append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    svg.attr("height", barHeight*maxCharacters + margin.top + margin.bottom);

  // var y = d3.scaleBand() 
  //     .rangeRound([0, height])
  //     .paddingInner(0.15)
  //     .align(0.1);

  var x = d3.scaleLinear()
      .rangeRound([0, width]);

  // var z = d3.schemeCategory20c;
  // var z = d3.scaleOrdinal() //  or d3.schemeCategory20c between () and no .range
      // .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00", "#FEC574"]);

  // y.domain(data.map(function(d) { return d.name; }));
  x.domain([0, end]).nice();
  // z.domain(["1", "2"]);

  console.log(data);

  for(i=0; i<data.length; i++){
    g.append("g")
    .selectAll("g")
    .data(data[i].characters)
    .enter().append("rect")
      //.attr("y", function(d){return height/2 + (barHeight * d.index) - (barHeight * d.total)/2}) // center baseline
      .attr("y", function(d){return height - (barHeight * d.index)}) // bottom baseline
      .attr("x", function(d){return x(data[i].absStartmSec)})
      .attr("width", function(d){return x(data[i].absEndmSec) - x(data[i].absStartmSec)})
      .attr("height", barHeight)
      .attr("fill", function(d){
        return d3.interpolateSinebow(uniqueCharacters.indexOf(d.name)/uniqueCharacters.length);
      })
      .attr("class", function(d){return d.name.toLowerCase().replace(/([^A-Z0-9])/gi,"")})
      .append("svg:title")
        .text(function(d) {return d.name + " - " + data[i].primary.split(".").slice(1,).join(".")});
  }

  var t = d3.transition()
    .duration(2000)
    .ease(d3.easeCubic);

  // transition to center baseline
  d3.select("button.center").on("click", function() {
    d3.select(".center")
      .attr("disabled", "disabled");
    d3.select(".baseline")
      .attr("disabled", null);
    d3.selectAll("rect")
      .interrupt()
      .transition(t)
      .delay(function(d, i) { return i * 5; })
      .attr("y", function(d){return height/2 - (barHeight * d.index) + (barHeight * d.total)/2}) // center baseline
  })

  d3.select("button.baseline").on("click", function(){
    d3.select(".baseline")
      .attr("disabled", "disabled");
    d3.select(".center")
      .attr("disabled", null);
    d3.selectAll("rect")
      .interrupt()
      .transition(t)
      .attr("y", function(d){return height - (barHeight * d.index)}) // bottom baseline
  })

  d3.selectAll("rect")
    .on("mouseover", function(){
      d3.selectAll("rect")
        .style("opacity", 0.3)
      d3.selectAll("."+d3.select(this).attr("class"))
        .style("opacity", 1)
    })
    .on("mouseout", function(){
      d3.selectAll("rect")
        .style("opacity", 1)
    })

};

    </script>
  </body>
</html>